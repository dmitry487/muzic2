<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ API</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #fff;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { margin-bottom: 2rem; color: #1db954; }
        .section {
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #b3b3b3;
        }
        input, button {
            width: 100%;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #333;
            background: #0f0f0f;
            color: #fff;
            font-size: 1rem;
        }
        button {
            background: #1db954;
            color: #000;
            border: none;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
        button:hover {
            background: #1ed760;
        }
        .result {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #1a2a1a;
            border: 1px solid #1db954;
            border-radius: 8px;
            display: none;
        }
        .result.show {
            display: block;
        }
        .result-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #0f0f0f;
            border-radius: 8px;
        }
        .cover-preview {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .track-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .track-card {
            background: #0f0f0f;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .track-card:hover {
            background: #1a1a1a;
        }
        .track-cover {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .track-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .track-artist {
            color: #b3b3b3;
            font-size: 0.9rem;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .loading.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö API</h1>
        
        <div class="section">
            <h2>–ü–æ–∏—Å–∫ —Ç—Ä–µ–∫–∞</h2>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</label>
                <input type="text" id="searchQuery" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Bohemian Rhapsody">
            </div>
            <button onclick="searchTracks()">üîç –ü–æ–∏—Å–∫</button>
            
            <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            
            <div class="track-list" id="trackList"></div>
        </div>
        
        <div class="section">
            <h2>–ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç—Ä–µ–∫–∞</h2>
            <p style="color: #666; margin-bottom: 1rem;">
                –í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏—Å—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –µ–≥–æ —Ç—Ä–µ–∫–æ–≤ –∏–∑ iTunes API. –ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç—Ä–µ–∫ –∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞.
            </p>
            <div class="form-group">
                <label>–ê—Ä—Ç–∏—Å—Ç *</label>
                <input type="text" id="trackArtist" placeholder="–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="trackTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ - –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç—Ä–µ–∫">
            </div>
            <div class="form-group">
                <label>–ê–ª—å–±–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="trackAlbum" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞">
            </div>
            <button onclick="getMetadata()">üì• –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞</button>
            
            <div class="result" id="metadataResult">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
                <div id="metadataContent"></div>
                <div id="metadataActions" style="margin-top: 1rem; display: none;">
                    <button onclick="saveMetadataAsNew()" style="background: #1db954; margin-right: 0.5rem;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π —Ç—Ä–µ–∫</button>
                    <button onclick="updateExistingTrack()" style="background: #333; margin-right: 0.5rem;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç—Ä–µ–∫</button>
                    <button onclick="saveArtistFromMetadata()" style="background: #2962ff;">üë§ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞—Ä—Ç–∏—Å—Ç–∞ (–∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö)</button>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏</h2>
            <div class="form-group">
                <label>–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É</label>
                <input type="text" id="trackFilePath" placeholder="tracks/music/track.mp3">
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="newTrackTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞">
            </div>
            <div class="form-group">
                <label>–ê—Ä—Ç–∏—Å—Ç</label>
                <input type="text" id="newTrackArtist" placeholder="–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞">
            </div>
            <button onclick="addTrackWithMetadata()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫</button>
            
            <div class="result" id="addTrackResult">
                <div id="addTrackContent"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>–î–æ–±–∞–≤–∏—Ç—å / –æ–±–Ω–æ–≤–∏—Ç—å –∞—Ä—Ç–∏—Å—Ç–∞</h2>
            <p style="color: #666; margin-bottom: 1rem;">
                –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞—Ä—Ç–∏—Å—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —á–µ—Ä–µ–∑ API. –î–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (iTunes / Deezer) –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é.
            </p>
            <div class="form-group">
                <label>–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞</label>
                <input type="text" id="artistNameApi" placeholder="–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞">
            </div>
            <div class="form-group">
                <label>URL –æ–±–ª–æ–∂–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="artistCoverApi" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>–ë–∏–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="artistBioApi" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ç–∏—Å—Ç–∞">
            </div>
            <button onclick="saveArtistManual()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞—Ä—Ç–∏—Å—Ç–∞</button>
            
            <div class="result" id="addArtistResult">
                <div id="addArtistContent"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º</h2>
            <p style="color: #666; margin-bottom: 1rem;">
                –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ tracks/music/filename.mp3
            </p>
            <button onclick="fixFilePaths()">üîß –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Ç–∏</button>
            <button onclick="fixFilePaths(true)" style="background: #ff4444; margin-left: 0.5rem;">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</button>
            
            <div class="result" id="fixPathsResult">
                <div id="fixPathsContent"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö</h2>
            <p style="color: #666; margin-bottom: 1rem;">
                –ó–∞–ø–æ–ª–Ω–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –æ–±–ª–æ–∂–∫–∏, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –∞–ª—å–±–æ–º—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–µ–∫–æ–≤
            </p>
            <button onclick="autoFillMetadata()">üîÑ –ó–∞–ø–æ–ª–Ω–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</button>
            
            <div class="result" id="autoFillResult">
                <div id="autoFillContent"></div>
            </div>
        </div>
    </div>

    <script>
        async function searchTracks() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            const loading = document.getElementById('loading');
            const trackList = document.getElementById('trackList');
            
            loading.classList.add('show');
            trackList.innerHTML = '';
            
            try {
                const response = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'search_tracks',
                        query: query,
                        limit: 20
                    })
                });
                
                const data = await response.json();
                loading.classList.remove('show');
                
                if (data.success && data.tracks.length > 0) {
                    trackList.innerHTML = data.tracks.map(track => `
                        <div class="track-card" onclick="selectTrack('${track.title}', '${track.artist}', '${track.album || ''}')">
                            ${track.cover ? `<img src="${track.cover}" class="track-cover" alt="cover">` : ''}
                            <div class="track-title">${track.title}</div>
                            <div class="track-artist">${track.artist}</div>
                            ${track.album ? `<div class="track-artist">${track.album}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    trackList.innerHTML = '<p style="color: #666;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                }
            } catch (error) {
                loading.classList.remove('show');
                alert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message);
            }
        }
        
        function selectTrack(title, artist, album) {
            document.getElementById('trackTitle').value = title;
            document.getElementById('trackArtist').value = artist;
            document.getElementById('trackAlbum').value = album;
        }
        
        let currentMetadata = null;
        
        async function getMetadata() {
            const title = document.getElementById('trackTitle').value.trim();
            const artist = document.getElementById('trackArtist').value.trim();
            const album = document.getElementById('trackAlbum').value.trim();
            
            if (!artist) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞—Ä—Ç–∏—Å—Ç–∞');
                return;
            }
            
            const result = document.getElementById('metadataResult');
            const content = document.getElementById('metadataContent');
            const actions = document.getElementById('metadataActions');
            
            content.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤ –∞—Ä—Ç–∏—Å—Ç–∞...</p>';
            actions.style.display = 'none';
            result.classList.add('show');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞
                const response = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_metadata',
                        title: title,
                        artist: artist,
                        album: album,
                        get_all_tracks: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.tracks && data.tracks.length > 0) {
                    // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∏—â–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç—Ä–µ–∫
                    if (title) {
                        const exactMatch = data.tracks.find(t => 
                            t.title.toLowerCase() === title.toLowerCase()
                        );
                        if (exactMatch) {
                            currentMetadata = exactMatch;
                            content.innerHTML = `
                                <div class="result-item">
                                    <strong>–ù–∞–π–¥–µ–Ω —Ç—Ä–µ–∫:</strong><br>
                                    <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${exactMatch.title}<br>
                                    <strong>–ê—Ä—Ç–∏—Å—Ç:</strong> ${exactMatch.artist}<br>
                                    <strong>–ê–ª—å–±–æ–º:</strong> ${exactMatch.album || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                                    <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${exactMatch.duration ? formatTime(exactMatch.duration) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}<br>
                                    <strong>–ñ–∞–Ω—Ä:</strong> ${exactMatch.genre || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                                    <strong>–ì–æ–¥:</strong> ${exactMatch.year || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                                    ${exactMatch.cover ? `<img src="${exactMatch.cover}" class="cover-preview" alt="cover">` : ''}
                                </div>
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                                    <strong>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —Ç—Ä–µ–∫–æ–≤: ${data.count}</strong>
                                    <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                                        ${data.tracks.map((track, index) => `
                                            <div style="padding: 10px; margin: 5px 0; background: #2a2a2a; border-radius: 4px; cursor: pointer;" 
                                                 onclick="selectTrackFromList('${track.title.replace(/'/g, "\\'")}', '${track.artist.replace(/'/g, "\\'")}', '${(track.album || '').replace(/'/g, "\\'")}')">
                                                <strong>${index + 1}. ${track.title}</strong><br>
                                                <small>–ê–ª—å–±–æ–º: ${track.album || '–ù–µ —É–∫–∞–∑–∞–Ω'} | ${track.duration ? formatTime(track.duration) : '?'}</small>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                            actions.style.display = 'block';
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –µ—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç
                            showAllTracks(data.tracks, content, actions);
                        }
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞
                        showAllTracks(data.tracks, content, actions);
                    }
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–¢—Ä–µ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    actions.style.display = 'none';
                    currentMetadata = null;
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
                actions.style.display = 'none';
                currentMetadata = null;
            }
        }
        
        function showAllTracks(tracks, content, actions) {
            content.innerHTML = `
                <div class="result-item">
                    <strong>–ù–∞–π–¥–µ–Ω–æ —Ç—Ä–µ–∫–æ–≤: ${tracks.length}</strong>
                    <div style="max-height: 500px; overflow-y: auto; margin-top: 15px;">
                        ${tracks.map((track, index) => `
                            <div style="padding: 12px; margin: 8px 0; background: #2a2a2a; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 12px;" 
                                 onclick="selectTrackFromList('${track.title.replace(/'/g, "\\'")}', '${track.artist.replace(/'/g, "\\'")}', '${(track.album || '').replace(/'/g, "\\'")}')"
                                 onmouseover="this.style.background='#333'" 
                                 onmouseout="this.style.background='#2a2a2a'">
                                ${track.cover ? `<img src="${track.cover}" style="width: 60px; height: 60px; border-radius: 4px; object-fit: cover;">` : '<div style="width: 60px; height: 60px; background: #444; border-radius: 4px;"></div>'}
                                <div style="flex: 1;">
                                    <strong style="display: block; margin-bottom: 4px;">${track.title}</strong>
                                    <small style="color: #999;">${track.album || '–ë–µ–∑ –∞–ª—å–±–æ–º–∞'}</small><br>
                                    <small style="color: #666;">${track.duration ? formatTime(track.duration) : '?'} | ${track.genre || ''} | ${track.year || ''}</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            actions.style.display = 'none';
        }
        
        function selectTrackFromList(title, artist, album) {
            document.getElementById('trackTitle').value = title;
            document.getElementById('trackArtist').value = artist;
            document.getElementById('trackAlbum').value = album;
            
            // –ù–∞—Ö–æ–¥–∏–º —Ç—Ä–µ–∫ –≤ —Å–ø–∏—Å–∫–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–∫ currentMetadata
            const content = document.getElementById('metadataContent');
            const actions = document.getElementById('metadataActions');
            const result = document.getElementById('metadataResult');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
            // –ò–ª–∏ –¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            getMetadata();
        }
        
        async function saveMetadataAsNew() {
            if (!currentMetadata) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ');
                return;
            }
            
            const filePath = prompt('–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Ç—Ä–µ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: tracks/music/track.mp3):');
            if (!filePath) {
                return;
            }
            
            try {
                const response = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_track',
                        title: currentMetadata.title,
                        artist: currentMetadata.artist,
                        album: currentMetadata.album || '',
                        duration: currentMetadata.duration || 0,
                        cover: currentMetadata.cover || '',
                        file_path: filePath
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ –¢—Ä–µ–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! ID: ' + data.id);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('trackTitle').value = '';
                    document.getElementById('trackArtist').value = '';
                    document.getElementById('trackAlbum').value = '';
                    document.getElementById('metadataResult').classList.remove('show');
                    currentMetadata = null;
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function updateExistingTrack() {
            if (!currentMetadata) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ');
                return;
            }
            
            const trackId = prompt('–í–≤–µ–¥–∏—Ç–µ ID —Ç—Ä–µ–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:');
            if (!trackId || isNaN(trackId)) {
                return;
            }
            
            try {
                const response = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_track',
                        track_id: parseInt(trackId),
                        title: currentMetadata.title,
                        artist: currentMetadata.artist,
                        album: currentMetadata.album || '',
                        duration: currentMetadata.duration || 0,
                        cover: currentMetadata.cover || ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ –¢—Ä–µ–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!');
                    document.getElementById('metadataResult').classList.remove('show');
                    currentMetadata = null;
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function fixFilePaths(apply = false) {
            const result = document.getElementById('fixPathsResult');
            const content = document.getElementById('fixPathsContent');
            
            content.innerHTML = '<p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–µ–π...</p>';
            result.classList.add('show');
            
            try {
                const url = `/muzic2/src/api/fix_file_paths.php${apply ? '?apply=1' : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    if (apply) {
                        content.innerHTML = `
                            <div class="result-item">
                                <strong>‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—É—Ç–µ–π:</strong> ${data.updated || 0}<br>
                                <strong>–í—Å–µ–≥–æ —Ç—Ä–µ–∫–æ–≤:</strong> ${data.total || 0}
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="result-item">
                                <strong>–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø—É—Ç–µ–π:</strong> ${data.pending || 0}<br>
                                <strong>–í—Å–µ–≥–æ —Ç—Ä–µ–∫–æ–≤:</strong> ${data.total || 0}<br>
                                ${data.preview && data.preview.length > 0 ? `
                                    <strong>–ü—Ä–∏–º–µ—Ä—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π:</strong><br>
                                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #999;">
                                        ${data.preview.map(p => `
                                            ID ${p.id}: "${p.from}" ‚Üí "${p.to}"
                                        `).join('<br>')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        async function addTrackWithMetadata() {
            const filePath = document.getElementById('trackFilePath').value.trim();
            const title = document.getElementById('newTrackTitle').value.trim();
            const artist = document.getElementById('newTrackArtist').value.trim();
            
            if (!filePath || !title || !artist) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            const result = document.getElementById('addTrackResult');
            const content = document.getElementById('addTrackContent');
            
            content.innerHTML = '<p>–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö...</p>';
            result.classList.add('show');
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                const metaResponse = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_metadata',
                        title: title,
                        artist: artist
                    })
                });
                
                const metaData = await metaResponse.json();
                let metadata = metaData.success && metaData.data ? metaData.data : {
                    title: title,
                    artist: artist,
                    album: '',
                    duration: 0,
                    cover: ''
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–µ–∫
                const saveResponse = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_track',
                        title: metadata.title || title,
                        artist: metadata.artist || artist,
                        album: metadata.album || '',
                        duration: metadata.duration || 0,
                        cover: metadata.cover || '',
                        file_path: filePath
                    })
                });
                
                const saveData = await saveResponse.json();
                
                if (saveData.success) {
                    content.innerHTML = `
                        <div class="result-item">
                            <strong>‚úÖ –¢—Ä–µ–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!</strong><br>
                            <strong>ID:</strong> ${saveData.id}<br>
                            <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${metadata.title || title}<br>
                            <strong>–ê—Ä—Ç–∏—Å—Ç:</strong> ${metadata.artist || artist}<br>
                            <strong>–ê–ª—å–±–æ–º:</strong> ${metadata.album || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                            <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${metadata.duration ? formatTime(metadata.duration) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}
                        </div>
                        ${metadata.cover ? `
                            <div class="result-item">
                                <img src="${metadata.cover}" class="cover-preview" alt="cover">
                            </div>
                        ` : ''}
                    `;
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('trackFilePath').value = '';
                    document.getElementById('newTrackTitle').value = '';
                    document.getElementById('newTrackArtist').value = '';
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (saveData.error || saveData.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        async function saveArtistFromMetadata() {
            const resultBlock = document.getElementById('addArtistResult');
            const contentBlock = document.getElementById('addArtistContent');
            
            if (!currentMetadata) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∞, —á—Ç–æ–±—ã –≤–∑—è—Ç—å –∏–º—è –∞—Ä—Ç–∏—Å—Ç–∞ –∏ –æ–±–ª–æ–∂–∫—É');
                return;
            }
            
            const artistName = (currentMetadata.artist || '').trim() || document.getElementById('trackArtist').value.trim();
            if (!artistName) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–º—è –∞—Ä—Ç–∏—Å—Ç–∞');
                return;
            }
            
            const cover = (currentMetadata.cover || '').trim();
            
            resultBlock.classList.add('show');
            contentBlock.innerHTML = '<p>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–∏—Å—Ç–∞ —á–µ—Ä–µ–∑ API...</p>';
            
            try {
                const response = await fetch('/muzic2/add_artist_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        artist_name: artistName,
                        cover: cover,
                        bio: ''
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    contentBlock.innerHTML = `
                        <div class="result-item">
                            <strong>‚úÖ –ê—Ä—Ç–∏—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!</strong><br>
                            <strong>–ò–º—è:</strong> ${data.data.artist_name}<br>
                            ${data.data.cover ? `<strong>–û–±–ª–æ–∂–∫–∞:</strong> ${data.data.cover}<br>` : ''}
                        </div>
                    `;
                    document.getElementById('artistNameApi').value = data.data.artist_name;
                    document.getElementById('artistCoverApi').value = data.data.cover || '';
                } else {
                    contentBlock.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                contentBlock.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        async function saveArtistManual() {
            const nameInput = document.getElementById('artistNameApi');
            const coverInput = document.getElementById('artistCoverApi');
            const bioInput = document.getElementById('artistBioApi');
            
            const name = nameInput.value.trim();
            const cover = coverInput.value.trim();
            const bio = bioInput.value.trim();
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∞—Ä—Ç–∏—Å—Ç–∞');
                return;
            }
            
            const resultBlock = document.getElementById('addArtistResult');
            const contentBlock = document.getElementById('addArtistContent');
            resultBlock.classList.add('show');
            contentBlock.innerHTML = '<p>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–∏—Å—Ç–∞ —á–µ—Ä–µ–∑ API...</p>';
            
            try {
                const response = await fetch('/muzic2/add_artist_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        artist_name: name,
                        cover: cover,
                        bio: bio
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    contentBlock.innerHTML = `
                        <div class="result-item">
                            <strong>‚úÖ –ê—Ä—Ç–∏—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!</strong><br>
                            <strong>–ò–º—è:</strong> ${data.data.artist_name}<br>
                            ${data.data.cover ? `<strong>–û–±–ª–æ–∂–∫–∞:</strong> ${data.data.cover}<br>` : ''}
                            ${data.data.bio ? `<strong>–ë–∏–æ:</strong> ${data.data.bio}<br>` : ''}
                        </div>
                    `;
                } else {
                    contentBlock.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                contentBlock.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        async function autoFillMetadata() {
            if (!confirm('–ó–∞–ø–æ–ª–Ω–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤ —Å –Ω–µ–ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.')) {
                return;
            }
            
            const result = document.getElementById('autoFillResult');
            const content = document.getElementById('autoFillContent');
            
            content.innerHTML = '<p>–û–±—Ä–∞–±–æ—Ç–∫–∞...</p>';
            result.classList.add('show');
            
            try {
                const response = await fetch('/muzic2/src/api/auto_fill_metadata.php');
                const data = await response.json();
                
                if (data.success) {
                    content.innerHTML = `
                        <div class="result-item">
                            <strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ —Ç—Ä–µ–∫–æ–≤:</strong> ${data.updated || 0}<br>
                            <strong>–û—à–∏–±–æ–∫:</strong> ${data.errors || 0}<br>
                            <strong>–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${data.total || 0}
                        </div>
                    `;
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }
        
        // –ü–æ–∏—Å–∫ –ø–æ Enter
        document.getElementById('searchQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchTracks();
        });
    </script>
</body>
</html>

