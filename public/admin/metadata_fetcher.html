<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ API</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #fff;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { margin-bottom: 2rem; color: #1db954; }
        .section {
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #b3b3b3;
        }
        input, button {
            width: 100%;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #333;
            background: #0f0f0f;
            color: #fff;
            font-size: 1rem;
        }
        button {
            background: #1db954;
            color: #000;
            border: none;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
        button:hover {
            background: #1ed760;
        }
        .result {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #1a2a1a;
            border: 1px solid #1db954;
            border-radius: 8px;
            display: none;
        }
        .result.show {
            display: block;
        }
        .result-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #0f0f0f;
            border-radius: 8px;
        }
        .cover-preview {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .track-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .track-card {
            background: #0f0f0f;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .track-card:hover {
            background: #1a1a1a;
        }
        .track-cover {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .track-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .track-artist {
            color: #b3b3b3;
            font-size: 0.9rem;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .loading.show {
            display: block;
        }
        .album-card {
            background: #0f0f0f;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 2px solid #333;
            cursor: pointer;
            transition: all 0.3s;
        }
        .album-card:hover {
            border-color: #1db954;
            background: #1a1a1a;
        }
        .album-card.selected {
            border-color: #1db954;
            background: #1a2a1a;
        }
        .album-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .album-cover-large {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .album-info {
            flex: 1;
        }
        .album-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .album-meta {
            color: #b3b3b3;
            font-size: 0.9rem;
        }
        .album-tracks {
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .track-checkbox {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: #0a0a0a;
            border-radius: 4px;
        }
        .track-checkbox input[type="checkbox"] {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .track-checkbox label {
            flex: 1;
            cursor: pointer;
            margin: 0;
        }
        .album-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        .album-actions button {
            flex: 1;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö API</h1>
        
        <div class="section">
            <h2>–ü–æ–∏—Å–∫ —Ç—Ä–µ–∫–∞</h2>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</label>
                <input type="text" id="searchQuery" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Bohemian Rhapsody">
            </div>
            <button onclick="searchTracks()">üîç –ü–æ–∏—Å–∫</button>
            
            <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            
            <div class="track-list" id="trackList"></div>
        </div>
        
        <div class="section">
            <h2>–ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç—Ä–µ–∫–∞</h2>
            <p style="color: #666; margin-bottom: 1rem;">
                –í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏—Å—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –µ–≥–æ —Ç—Ä–µ–∫–æ–≤ –∏–∑ iTunes API. –ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç—Ä–µ–∫ –∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞.
            </p>
            <div class="form-group">
                <label>–ê—Ä—Ç–∏—Å—Ç *</label>
                <input type="text" id="trackArtist" placeholder="–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="trackTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ - –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç—Ä–µ–∫">
            </div>
            <div class="form-group">
                <label>–ê–ª—å–±–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="trackAlbum" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞">
            </div>
            <button onclick="getMetadata()">üì• –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞</button>
            
            <div class="result" id="metadataResult">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
                <div id="metadataContent"></div>
                    <div id="metadataActions" style="margin-top: 1rem; display: none;">
                    <button onclick="saveMetadataAsNew()" style="background: #1db954; margin-right: 0.5rem;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π —Ç—Ä–µ–∫</button>
                    <button onclick="updateExistingTrack()" style="background: #333; margin-right: 0.5rem;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç—Ä–µ–∫</button>
                    <button onclick="saveArtistFromMetadata()" style="background: #2962ff; margin-right: 0.5rem;">üë§ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞—Ä—Ç–∏—Å—Ç–∞ (–∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö)</button>
                    <button onclick="addAlbumFromTracks()" style="background: #ff6b00; display: none;" id="addAlbumFromTracksBtn">üìÄ –î–æ–±–∞–≤–∏—Ç—å –∞–ª—å–±–æ–º –∏–∑ —Ç—Ä–µ–∫–æ–≤</button>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>üöÄ –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞</h2>
            <p style="color: #666; margin-bottom: 1rem;">
                –ü–æ–ª—É—á–∏—Ç–µ –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞ (–∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–ª—å–±–æ–º–∞), –≤—ã–±–µ—Ä–∏—Ç–µ –∞–ª—å–±–æ–º –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ —Ü–µ–ª–∏–∫–æ–º —Å –æ–±–ª–æ–∂–∫–æ–π –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏. –ü–æ–∏—Å–∫ —É–ª—É—á—à–µ–Ω: –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
            </p>
            <div class="form-group">
                <label>–ê—Ä—Ç–∏—Å—Ç *</label>
                <input type="text" id="albumArtist" placeholder="–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="albumName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞ - –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞">
                <small style="color: #666; display: block; margin-top: 0.25rem;">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞–ª—å–±–æ–º. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤—Å–µ –∞–ª—å–±–æ–º—ã –∞—Ä—Ç–∏—Å—Ç–∞.</small>
            </div>
            <button onclick="loadAlbumsForArtist()">üìÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–ª—å–±–æ–º—ã</button>
            
            <div class="result" id="albumListResult" style="display: none;">
                <h3>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∞–ª—å–±–æ–º—ã:</h3>
                <div id="albumListContent"></div>
            </div>
            
            <div class="result" id="addAlbumResult" style="display: none;">
                <div id="addAlbumContent"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏</h2>
            <div class="form-group">
                <label>–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É</label>
                <input type="text" id="trackFilePath" placeholder="tracks/music/track.mp3">
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="newTrackTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞">
            </div>
            <div class="form-group">
                <label>–ê—Ä—Ç–∏—Å—Ç</label>
                <input type="text" id="newTrackArtist" placeholder="–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞">
            </div>
            <button onclick="addTrackWithMetadata()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫</button>
            
            <div class="result" id="addTrackResult">
                <div id="addTrackContent"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>–î–æ–±–∞–≤–∏—Ç—å / –æ–±–Ω–æ–≤–∏—Ç—å –∞—Ä—Ç–∏—Å—Ç–∞</h2>
            <p style="color: #666; margin-bottom: 1rem;">
                –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞—Ä—Ç–∏—Å—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —á–µ—Ä–µ–∑ API. –î–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (iTunes / Deezer) –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é.
            </p>
            <div class="form-group">
                <label>–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞</label>
                <input type="text" id="artistNameApi" placeholder="–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞">
            </div>
            <div class="form-group">
                <label>URL –æ–±–ª–æ–∂–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="artistCoverApi" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>–ë–∏–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="text" id="artistBioApi" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ç–∏—Å—Ç–∞">
            </div>
            <button onclick="saveArtistManual()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞—Ä—Ç–∏—Å—Ç–∞</button>
            
            <div class="result" id="addArtistResult">
                <div id="addArtistContent"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º</h2>
            <p style="color: #666; margin-bottom: 1rem;">
                –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ tracks/music/filename.mp3
            </p>
            <button onclick="fixFilePaths()">üîß –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Ç–∏</button>
            <button onclick="fixFilePaths(true)" style="background: #ff4444; margin-left: 0.5rem;">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</button>
            
            <div class="result" id="fixPathsResult">
                <div id="fixPathsContent"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö</h2>
            <p style="color: #666; margin-bottom: 1rem;">
                –ó–∞–ø–æ–ª–Ω–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –æ–±–ª–æ–∂–∫–∏, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –∞–ª—å–±–æ–º—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–µ–∫–æ–≤
            </p>
            <button onclick="autoFillMetadata()">üîÑ –ó–∞–ø–æ–ª–Ω–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</button>
            
            <div class="result" id="autoFillResult">
                <div id="autoFillContent"></div>
            </div>
        </div>
    </div>

    <script>
        async function searchTracks() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            const loading = document.getElementById('loading');
            const trackList = document.getElementById('trackList');
            
            loading.classList.add('show');
            trackList.innerHTML = '';
            
            try {
                const response = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'search_tracks',
                        query: query,
                        limit: 20
                    })
                });
                
                const data = await response.json();
                loading.classList.remove('show');
                
                if (data.success && data.tracks.length > 0) {
                    trackList.innerHTML = data.tracks.map(track => `
                        <div class="track-card" onclick="selectTrack('${track.title}', '${track.artist}', '${track.album || ''}')">
                            ${track.cover ? `<img src="${track.cover}" class="track-cover" alt="cover">` : ''}
                            <div class="track-title">${track.title}</div>
                            <div class="track-artist">${track.artist}</div>
                            ${track.album ? `<div class="track-artist">${track.album}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    trackList.innerHTML = '<p style="color: #666;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                }
            } catch (error) {
                loading.classList.remove('show');
                alert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message);
            }
        }
        
        function selectTrack(title, artist, album) {
            document.getElementById('trackTitle').value = title;
            document.getElementById('trackArtist').value = artist;
            document.getElementById('trackAlbum').value = album;
        }
        
        let currentMetadata = null;
        let currentAlbumsData = null; // –•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –∞–ª—å–±–æ–º–æ–≤ –∞—Ä—Ç–∏—Å—Ç–∞
        let allTracksFromMetadata = null; // –•—Ä–∞–Ω–∏—Ç –≤—Å–µ —Ç—Ä–µ–∫–∏ –∏–∑ getMetadata –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–ª—å–±–æ–º–∞
        
        async function getMetadata() {
            const title = document.getElementById('trackTitle').value.trim();
            const artist = document.getElementById('trackArtist').value.trim();
            const album = document.getElementById('trackAlbum').value.trim();
            
            if (!artist) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞—Ä—Ç–∏—Å—Ç–∞');
                return;
            }
            
            const result = document.getElementById('metadataResult');
            const content = document.getElementById('metadataContent');
            const actions = document.getElementById('metadataActions');
            
            content.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤ –∞—Ä—Ç–∏—Å—Ç–∞...</p>';
            actions.style.display = 'none';
            result.classList.add('show');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞
                const response = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_metadata',
                        title: title,
                        artist: artist,
                        album: album,
                        get_all_tracks: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.tracks && data.tracks.length > 0) {
                    allTracksFromMetadata = data.tracks; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–ª—å–±–æ–º–∞
                    
                    // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∏—â–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç—Ä–µ–∫
                    if (title) {
                        const exactMatch = data.tracks.find(t => 
                            t.title.toLowerCase() === title.toLowerCase()
                        );
                        if (exactMatch) {
                            currentMetadata = exactMatch;
                            content.innerHTML = `
                                <div class="result-item">
                                    <strong>–ù–∞–π–¥–µ–Ω —Ç—Ä–µ–∫:</strong><br>
                                    <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${exactMatch.title}<br>
                                    <strong>–ê—Ä—Ç–∏—Å—Ç:</strong> ${exactMatch.artist}<br>
                                    <strong>–ê–ª—å–±–æ–º:</strong> ${exactMatch.album || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                                    <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${exactMatch.duration ? formatTime(exactMatch.duration) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}<br>
                                    <strong>–ñ–∞–Ω—Ä:</strong> ${exactMatch.genre || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                                    <strong>–ì–æ–¥:</strong> ${exactMatch.year || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                                    ${exactMatch.cover ? `<img src="${exactMatch.cover}" class="cover-preview" alt="cover">` : ''}
                                </div>
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                                    <strong>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —Ç—Ä–µ–∫–æ–≤: ${data.count}</strong>
                                    <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                                        ${data.tracks.map((track, index) => `
                                            <div style="padding: 10px; margin: 5px 0; background: #2a2a2a; border-radius: 4px; cursor: pointer;" 
                                                 onclick="selectTrackFromList('${track.title.replace(/'/g, "\\'")}', '${track.artist.replace(/'/g, "\\'")}', '${(track.album || '').replace(/'/g, "\\'")}')">
                                                <strong>${index + 1}. ${track.title}</strong><br>
                                                <small>–ê–ª—å–±–æ–º: ${track.album || '–ù–µ —É–∫–∞–∑–∞–Ω'} | ${track.duration ? formatTime(track.duration) : '?'}</small>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                            actions.style.display = 'block';
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–ª—å–±–æ–º–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–ª—å–±–æ–º
                            if (exactMatch.album) {
                                document.getElementById('addAlbumFromTracksBtn').style.display = 'inline-block';
                            }
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –µ—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç
                            showAllTracks(data.tracks, content, actions);
                        }
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞
                        showAllTracks(data.tracks, content, actions);
                    }
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–¢—Ä–µ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    actions.style.display = 'none';
                    currentMetadata = null;
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
                actions.style.display = 'none';
                currentMetadata = null;
            }
        }
        
        function showAllTracks(tracks, content, actions) {
            content.innerHTML = `
                <div class="result-item">
                    <strong>–ù–∞–π–¥–µ–Ω–æ —Ç—Ä–µ–∫–æ–≤: ${tracks.length}</strong>
                    <div style="max-height: 500px; overflow-y: auto; margin-top: 15px;">
                        ${tracks.map((track, index) => `
                            <div style="padding: 12px; margin: 8px 0; background: #2a2a2a; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 12px;" 
                                 onclick="selectTrackFromList('${track.title.replace(/'/g, "\\'")}', '${track.artist.replace(/'/g, "\\'")}', '${(track.album || '').replace(/'/g, "\\'")}')"
                                 onmouseover="this.style.background='#333'" 
                                 onmouseout="this.style.background='#2a2a2a'">
                                ${track.cover ? `<img src="${track.cover}" style="width: 60px; height: 60px; border-radius: 4px; object-fit: cover;">` : '<div style="width: 60px; height: 60px; background: #444; border-radius: 4px;"></div>'}
                                <div style="flex: 1;">
                                    <strong style="display: block; margin-bottom: 4px;">${track.title}</strong>
                                    <small style="color: #999;">${track.album || '–ë–µ–∑ –∞–ª—å–±–æ–º–∞'}</small><br>
                                    <small style="color: #666;">${track.duration ? formatTime(track.duration) : '?'} | ${track.genre || ''} | ${track.year || ''}</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            actions.style.display = 'none';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–ª—å–±–æ–º–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç—Ä–µ–∫–∏ —Å –∞–ª—å–±–æ–º–∞–º–∏
            const hasAlbums = tracks.some(t => t.album);
            if (hasAlbums) {
                document.getElementById('addAlbumFromTracksBtn').style.display = 'inline-block';
            } else {
                document.getElementById('addAlbumFromTracksBtn').style.display = 'none';
            }
        }
        
        async function addAlbumFromTracks() {
            if (!allTracksFromMetadata || allTracksFromMetadata.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞');
                return;
            }
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ç—Ä–µ–∫–∏ –ø–æ –∞–ª—å–±–æ–º–∞–º
            const albumsMap = {};
            allTracksFromMetadata.forEach(track => {
                const albumName = track.album || '–ë–µ–∑ –∞–ª—å–±–æ–º–∞';
                if (!albumsMap[albumName]) {
                    albumsMap[albumName] = {
                        name: albumName,
                        artist: track.artist,
                        cover: track.cover || '',
                        year: track.year || '',
                        tracks: [],
                        totalDuration: 0
                    };
                }
                albumsMap[albumName].tracks.push(track);
                albumsMap[albumName].totalDuration += track.duration || 0;
            });
            
            const albums = Object.values(albumsMap);
            
            if (albums.length === 0) {
                alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∞–ª—å–±–æ–º–æ–≤ –≤ —Å–ø–∏—Å–∫–µ —Ç—Ä–µ–∫–æ–≤');
                return;
            }
            
            // –ï—Å–ª–∏ –æ–¥–∏–Ω –∞–ª—å–±–æ–º, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —Å—Ä–∞–∑—É
            if (albums.length === 1) {
                await addSingleAlbumFromTracks(albums[0]);
                return;
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–ª—å–±–æ–º–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            const albumNames = albums.map(a => a.name).join('\n');
            const selectedAlbumName = prompt(`–ù–∞–π–¥–µ–Ω–æ ${albums.length} –∞–ª—å–±–æ–º–æ–≤:\n\n${albumNames}\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:`);
            
            if (!selectedAlbumName) return;
            
            const selectedAlbum = albums.find(a => a.name.toLowerCase() === selectedAlbumName.toLowerCase());
            if (selectedAlbum) {
                await addSingleAlbumFromTracks(selectedAlbum);
            } else {
                alert('–ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ');
            }
        }
        
        async function addSingleAlbumFromTracks(album) {
            const usePlaceholder = confirm(`–î–æ–±–∞–≤–∏—Ç—å –∞–ª—å–±–æ–º "${album.name}"?\n\n–¢—Ä–µ–∫–æ–≤: ${album.tracks.length}\n–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${formatTime(album.totalDuration)}\n\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å placeholder –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º?`);
            
                    const tracks = album.tracks.map(track => ({
                        title: track.title,
                        duration: track.duration || 0,
                        file_path: usePlaceholder ? 'tracks/music/' + track.title.replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø\s]/g, '').trim().replace(/\s+/g, '_') + '.mp3' : 'tracks/music/placeholder.mp3',
                        explicit: track.explicit || 0,
                        trackNumber: track.trackNumber || null,
                        discNumber: track.discNumber || null,
                        genre: track.genre || null,
                        year: track.year || null,
                        previewUrl: track.previewUrl || null,
                        collectionId: track.collectionId || null
                    }));
            
            const albumType = tracks.length <= 3 ? 'single' : (tracks.length <= 7 ? 'ep' : 'album');
            
            const result = document.getElementById('metadataResult');
            const content = document.getElementById('metadataContent');
            
            content.innerHTML = '<p>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞...</p>';
            result.classList.add('show');
            
            try {
                const response = await fetch('/muzic2/add_album_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        album_name: album.name,
                        artist_name: album.artist,
                        album_type: albumType,
                        selectedCover: album.cover || '',
                        release_year: album.year || new Date().getFullYear(),
                        description: '',
                        tracks: tracks
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    content.innerHTML = `
                        <div class="result-item">
                            <strong>‚úÖ –ê–ª—å–±–æ–º —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!</strong><br>
                            <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${data.data.album_name}<br>
                            <strong>–ê—Ä—Ç–∏—Å—Ç:</strong> ${data.data.artist_name}<br>
                            <strong>–¢—Ä–µ–∫–æ–≤:</strong> ${data.data.tracks_count}<br>
                            <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${data.data.total_duration}
                        </div>
                        ${data.data.cover ? `<img src="${data.data.cover}" class="cover-preview" alt="cover">` : ''}
                    `;
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        function selectTrackFromList(title, artist, album) {
            document.getElementById('trackTitle').value = title;
            document.getElementById('trackArtist').value = artist;
            document.getElementById('trackAlbum').value = album;
            
            // –ù–∞—Ö–æ–¥–∏–º —Ç—Ä–µ–∫ –≤ —Å–ø–∏—Å–∫–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–∫ currentMetadata
            const content = document.getElementById('metadataContent');
            const actions = document.getElementById('metadataActions');
            const result = document.getElementById('metadataResult');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
            // –ò–ª–∏ –¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            getMetadata();
        }
        
        async function saveMetadataAsNew() {
            if (!currentMetadata) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ');
                return;
            }
            
            // –£–ª—É—á—à–µ–Ω–Ω—ã–π –≤–≤–æ–¥ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É —Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º
            const defaultPath = 'tracks/music/' + (currentMetadata.title || 'track').replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø\s]/g, '').trim().replace(/\s+/g, '_') + '.mp3';
            const filePath = prompt('–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Ç—Ä–µ–∫–∞:', defaultPath);
            if (!filePath) {
                return;
            }
            
            const result = document.getElementById('metadataResult');
            const content = document.getElementById('metadataContent');
            
            content.innerHTML = '<p>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞...</p>';
            result.classList.add('show');
            
            try {
                const response = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_track',
                        title: currentMetadata.title,
                        artist: currentMetadata.artist,
                        album: currentMetadata.album || '',
                        duration: currentMetadata.duration || 0,
                        cover: currentMetadata.cover || '',
                        file_path: filePath
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    content.innerHTML = `
                        <div class="result-item">
                            <strong>‚úÖ –¢—Ä–µ–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!</strong><br>
                            <strong>ID:</strong> ${data.id}<br>
                            <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${currentMetadata.title}<br>
                            <strong>–ê—Ä—Ç–∏—Å—Ç:</strong> ${currentMetadata.artist}<br>
                            <strong>–ê–ª—å–±–æ–º:</strong> ${currentMetadata.album || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                            <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${currentMetadata.duration ? formatTime(currentMetadata.duration) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}
                        </div>
                        ${currentMetadata.cover ? `<img src="${currentMetadata.cover}" class="cover-preview" alt="cover">` : ''}
                    `;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                    setTimeout(() => {
                        document.getElementById('trackTitle').value = '';
                        document.getElementById('trackArtist').value = '';
                        document.getElementById('trackAlbum').value = '';
                        result.classList.remove('show');
                        currentMetadata = null;
                    }, 3000);
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        async function updateExistingTrack() {
            if (!currentMetadata) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ');
                return;
            }
            
            const trackId = prompt('–í–≤–µ–¥–∏—Ç–µ ID —Ç—Ä–µ–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:');
            if (!trackId || isNaN(trackId)) {
                return;
            }
            
            try {
                const response = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_track',
                        track_id: parseInt(trackId),
                        title: currentMetadata.title,
                        artist: currentMetadata.artist,
                        album: currentMetadata.album || '',
                        duration: currentMetadata.duration || 0,
                        cover: currentMetadata.cover || ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ –¢—Ä–µ–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!');
                    document.getElementById('metadataResult').classList.remove('show');
                    currentMetadata = null;
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function fixFilePaths(apply = false) {
            const result = document.getElementById('fixPathsResult');
            const content = document.getElementById('fixPathsContent');
            
            content.innerHTML = '<p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–µ–π...</p>';
            result.classList.add('show');
            
            try {
                const url = `/muzic2/src/api/fix_file_paths.php${apply ? '?apply=1' : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    if (apply) {
                        content.innerHTML = `
                            <div class="result-item">
                                <strong>‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—É—Ç–µ–π:</strong> ${data.updated || 0}<br>
                                <strong>–í—Å–µ–≥–æ —Ç—Ä–µ–∫–æ–≤:</strong> ${data.total || 0}
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="result-item">
                                <strong>–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø—É—Ç–µ–π:</strong> ${data.pending || 0}<br>
                                <strong>–í—Å–µ–≥–æ —Ç—Ä–µ–∫–æ–≤:</strong> ${data.total || 0}<br>
                                ${data.preview && data.preview.length > 0 ? `
                                    <strong>–ü—Ä–∏–º–µ—Ä—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π:</strong><br>
                                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #999;">
                                        ${data.preview.map(p => `
                                            ID ${p.id}: "${p.from}" ‚Üí "${p.to}"
                                        `).join('<br>')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        async function addTrackWithMetadata() {
            const filePath = document.getElementById('trackFilePath').value.trim();
            const title = document.getElementById('newTrackTitle').value.trim();
            const artist = document.getElementById('newTrackArtist').value.trim();
            
            if (!filePath || !title || !artist) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            const result = document.getElementById('addTrackResult');
            const content = document.getElementById('addTrackContent');
            
            content.innerHTML = '<p>–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö...</p>';
            result.classList.add('show');
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                const metaResponse = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_metadata',
                        title: title,
                        artist: artist
                    })
                });
                
                const metaData = await metaResponse.json();
                let metadata = metaData.success && metaData.data ? metaData.data : {
                    title: title,
                    artist: artist,
                    album: '',
                    duration: 0,
                    cover: ''
                };
                
                // –ï—Å–ª–∏ –ø—É—Ç—å –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
                let finalFilePath = filePath;
                if (!filePath || filePath === 'tracks/music/') {
                    const autoPath = 'tracks/music/' + (metadata.title || title).replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø\s]/g, '').trim().replace(/\s+/g, '_') + '.mp3';
                    finalFilePath = prompt('–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:', autoPath) || autoPath;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–µ–∫
                const saveResponse = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_track',
                        title: metadata.title || title,
                        artist: metadata.artist || artist,
                        album: metadata.album || '',
                        duration: metadata.duration || 0,
                        cover: metadata.cover || '',
                        file_path: finalFilePath
                    })
                });
                
                const saveData = await saveResponse.json();
                
                if (saveData.success) {
                    content.innerHTML = `
                        <div class="result-item">
                            <strong>‚úÖ –¢—Ä–µ–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!</strong><br>
                            <strong>ID:</strong> ${saveData.id}<br>
                            <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${metadata.title || title}<br>
                            <strong>–ê—Ä—Ç–∏—Å—Ç:</strong> ${metadata.artist || artist}<br>
                            <strong>–ê–ª—å–±–æ–º:</strong> ${metadata.album || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                            <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${metadata.duration ? formatTime(metadata.duration) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}<br>
                            <strong>–ü—É—Ç—å:</strong> ${finalFilePath}
                        </div>
                        ${metadata.cover ? `
                            <div class="result-item">
                                <img src="${metadata.cover}" class="cover-preview" alt="cover">
                            </div>
                        ` : ''}
                        <div style="margin-top: 1rem;">
                            <button onclick="document.getElementById('trackFilePath').value = '${finalFilePath}'; document.getElementById('newTrackTitle').value = '${metadata.title || title}'; document.getElementById('newTrackArtist').value = '${metadata.artist || artist}';" style="background: #333;">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç—Ä–µ–∫–∞</button>
                        </div>
                    `;
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã (—á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ)
                    setTimeout(() => {
                        document.getElementById('trackFilePath').value = '';
                        document.getElementById('newTrackTitle').value = '';
                        document.getElementById('newTrackArtist').value = '';
                    }, 5000);
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (saveData.error || saveData.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        async function saveArtistFromMetadata() {
            const resultBlock = document.getElementById('addArtistResult');
            const contentBlock = document.getElementById('addArtistContent');
            
            if (!currentMetadata) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∞, —á—Ç–æ–±—ã –≤–∑—è—Ç—å –∏–º—è –∞—Ä—Ç–∏—Å—Ç–∞ –∏ –æ–±–ª–æ–∂–∫—É');
                return;
            }
            
            const artistName = (currentMetadata.artist || '').trim() || document.getElementById('trackArtist').value.trim();
            if (!artistName) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–º—è –∞—Ä—Ç–∏—Å—Ç–∞');
                return;
            }
            
            const cover = (currentMetadata.cover || '').trim();
            
            resultBlock.classList.add('show');
            contentBlock.innerHTML = '<p>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–∏—Å—Ç–∞ —á–µ—Ä–µ–∑ API...</p>';
            
            try {
                const response = await fetch('/muzic2/add_artist_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        artist_name: artistName,
                        cover: cover,
                        bio: ''
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    contentBlock.innerHTML = `
                        <div class="result-item">
                            <strong>‚úÖ –ê—Ä—Ç–∏—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!</strong><br>
                            <strong>–ò–º—è:</strong> ${data.data.artist_name}<br>
                            ${data.data.cover ? `<strong>–û–±–ª–æ–∂–∫–∞:</strong> ${data.data.cover}<br>` : ''}
                        </div>
                    `;
                    document.getElementById('artistNameApi').value = data.data.artist_name;
                    document.getElementById('artistCoverApi').value = data.data.cover || '';
                } else {
                    contentBlock.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                contentBlock.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        async function saveArtistManual() {
            const nameInput = document.getElementById('artistNameApi');
            const coverInput = document.getElementById('artistCoverApi');
            const bioInput = document.getElementById('artistBioApi');
            
            const name = nameInput.value.trim();
            const cover = coverInput.value.trim();
            const bio = bioInput.value.trim();
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∞—Ä—Ç–∏—Å—Ç–∞');
                return;
            }
            
            const resultBlock = document.getElementById('addArtistResult');
            const contentBlock = document.getElementById('addArtistContent');
            resultBlock.classList.add('show');
            contentBlock.innerHTML = '<p>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–∏—Å—Ç–∞ —á–µ—Ä–µ–∑ API...</p>';
            
            try {
                const response = await fetch('/muzic2/add_artist_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        artist_name: name,
                        cover: cover,
                        bio: bio
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    contentBlock.innerHTML = `
                        <div class="result-item">
                            <strong>‚úÖ –ê—Ä—Ç–∏—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!</strong><br>
                            <strong>–ò–º—è:</strong> ${data.data.artist_name}<br>
                            ${data.data.cover ? `<strong>–û–±–ª–æ–∂–∫–∞:</strong> ${data.data.cover}<br>` : ''}
                            ${data.data.bio ? `<strong>–ë–∏–æ:</strong> ${data.data.bio}<br>` : ''}
                        </div>
                    `;
                } else {
                    contentBlock.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                contentBlock.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        async function autoFillMetadata() {
            if (!confirm('–ó–∞–ø–æ–ª–Ω–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤ —Å –Ω–µ–ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.')) {
                return;
            }
            
            const result = document.getElementById('autoFillResult');
            const content = document.getElementById('autoFillContent');
            
            content.innerHTML = '<p>–û–±—Ä–∞–±–æ—Ç–∫–∞...</p>';
            result.classList.add('show');
            
            try {
                const response = await fetch('/muzic2/src/api/auto_fill_metadata.php');
                const data = await response.json();
                
                if (data.success) {
                    content.innerHTML = `
                        <div class="result-item">
                            <strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ —Ç—Ä–µ–∫–æ–≤:</strong> ${data.updated || 0}<br>
                            <strong>–û—à–∏–±–æ–∫:</strong> ${data.errors || 0}<br>
                            <strong>–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${data.total || 0}
                        </div>
                    `;
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }
        
        // –ü–æ–∏—Å–∫ –ø–æ Enter
        document.getElementById('searchQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchTracks();
        });
        
        // –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞
        async function loadAlbumsForArtist() {
            const artist = document.getElementById('albumArtist').value.trim();
            const albumName = document.getElementById('albumName').value.trim();
            
            if (!artist) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∞—Ä—Ç–∏—Å—Ç–∞');
                return;
            }
            
            const result = document.getElementById('albumListResult');
            const content = document.getElementById('albumListContent');
            
            content.innerHTML = `<p>–ó–∞–≥—Ä—É–∑–∫–∞ ${albumName ? '–∞–ª—å–±–æ–º–∞ "' + albumName + '"' : '–∞–ª—å–±–æ–º–æ–≤'} –∞—Ä—Ç–∏—Å—Ç–∞ "${artist}"...<br><small style="color: #666;">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è, –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–æ 2500 —Ç—Ä–µ–∫–æ–≤...</small></p>`;
            result.style.display = 'block';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞—Ä—Ç–∏—Å—Ç–∞ (–∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–ª—å–±–æ–º–∞)
                const response = await fetch('/muzic2/src/api/music_metadata.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_metadata',
                        artist: artist,
                        album: albumName,
                        get_all_tracks: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.tracks && data.tracks.length > 0) {
                    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ç—Ä–µ–∫–∏ –ø–æ –∞–ª—å–±–æ–º–∞–º
                    const albumsMap = {};
                    data.tracks.forEach(track => {
                        const albumName = track.album || '–ë–µ–∑ –∞–ª—å–±–æ–º–∞';
                        if (!albumsMap[albumName]) {
                            albumsMap[albumName] = {
                                name: albumName,
                                artist: track.artist,
                                cover: '', // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π –æ–±–ª–æ–∂–∫–æ–π
                                year: track.year || '',
                                tracks: [],
                                totalDuration: 0
                            };
                        }
                        // –ï—Å–ª–∏ —É —Ç—Ä–µ–∫–∞ –µ—Å—Ç—å –æ–±–ª–æ–∂–∫–∞ –∏ —É –∞–ª—å–±–æ–º–∞ –µ—ë –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–ª–æ–∂–∫—É —Ç—Ä–µ–∫–∞
                        if (track.cover && track.cover.trim() && (!albumsMap[albumName].cover || albumsMap[albumName].cover.trim() === '')) {
                            albumsMap[albumName].cover = track.cover.trim();
                        }
                        albumsMap[albumName].tracks.push(track);
                        albumsMap[albumName].totalDuration += track.duration || 0;
                    });
                    
                    currentAlbumsData = Object.values(albumsMap);
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–ª—å–±–æ–º—ã
                    content.innerHTML = currentAlbumsData.map((album, index) => `
                        <div class="album-card" id="album-${index}" onclick="selectAlbum(${index})">
                            <div class="album-header">
                                ${album.cover ? `<img src="${album.cover}" class="album-cover-large" alt="cover">` : '<div class="album-cover-large" style="background: #333; display: flex; align-items: center; justify-content: center; color: #666;">–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏</div>'}
                                <div class="album-info">
                                    <div class="album-title">${album.name}</div>
                                    <div class="album-meta">
                                        –ê—Ä—Ç–∏—Å—Ç: ${album.artist}<br>
                                        –¢—Ä–µ–∫–æ–≤: ${album.tracks.length}<br>
                                        –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${formatTime(album.totalDuration)}<br>
                                        ${album.year ? `–ì–æ–¥: ${album.year}` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="album-tracks" id="album-tracks-${index}" style="display: none;">
                                <div style="margin-bottom: 0.5rem;">
                                    <label style="cursor: pointer;">
                                        <input type="checkbox" id="select-all-${index}" onchange="toggleAllTracks(${index}, this.checked)" checked>
                                        –í—ã–±—Ä–∞—Ç—å –≤—Å–µ (${album.tracks.length} —Ç—Ä–µ–∫–æ–≤)
                                    </label>
                                </div>
                                ${album.tracks.map((track, trackIndex) => `
                                    <div class="track-checkbox">
                                        <input type="checkbox" id="track-${index}-${trackIndex}" class="album-track-checkbox" data-album="${index}" data-track="${trackIndex}" checked>
                                        <label for="track-${index}-${trackIndex}">
                                            <strong>${track.title}</strong>
                                            ${track.duration ? ` (${formatTime(track.duration)})` : ''}
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="album-actions" id="album-actions-${index}" style="display: none;">
                                <button onclick="event.stopPropagation(); addAlbumQuickly(${index});" style="background: #1db954;">üíæ –î–æ–±–∞–≤–∏—Ç—å –∞–ª—å–±–æ–º</button>
                                <button onclick="event.stopPropagation(); toggleAlbumTracks(${index});" style="background: #333;">üìã –ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–∫–∏</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–ê–ª—å–±–æ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    currentAlbumsData = null;
                }
            } catch (error) {
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
                currentAlbumsData = null;
            }
        }
        
        function selectAlbum(index) {
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö –∞–ª—å–±–æ–º–æ–≤
            document.querySelectorAll('.album-card').forEach(card => {
                card.classList.remove('selected');
                const cardIndex = parseInt(card.id.split('-')[1]);
                if (cardIndex !== index) {
                    document.getElementById(`album-tracks-${cardIndex}`).style.display = 'none';
                    document.getElementById(`album-actions-${cardIndex}`).style.display = 'none';
                }
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–ª—å–±–æ–º
            const albumCard = document.getElementById(`album-${index}`);
            albumCard.classList.add('selected');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ç—Ä–µ–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è
            toggleAlbumTracks(index);
        }
        
        function toggleAlbumTracks(index) {
            const tracksDiv = document.getElementById(`album-tracks-${index}`);
            const actionsDiv = document.getElementById(`album-actions-${index}`);
            
            if (tracksDiv.style.display === 'none') {
                tracksDiv.style.display = 'block';
                actionsDiv.style.display = 'flex';
            } else {
                tracksDiv.style.display = 'none';
                actionsDiv.style.display = 'none';
            }
        }
        
        function toggleAllTracks(albumIndex, checked) {
            const checkboxes = document.querySelectorAll(`input.album-track-checkbox[data-album="${albumIndex}"]`);
            checkboxes.forEach(cb => cb.checked = checked);
        }
        
        async function addAlbumQuickly(albumIndex) {
            if (!currentAlbumsData || !currentAlbumsData[albumIndex]) {
                alert('–î–∞–Ω–Ω—ã–µ –∞–ª—å–±–æ–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                return;
            }
            
            const album = currentAlbumsData[albumIndex];
            const selectedTracks = [];
            
            // –ù–∞—Ö–æ–¥–∏–º –æ–±–ª–æ–∂–∫—É –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ (–µ—Å–ª–∏ —É –∞–ª—å–±–æ–º–∞ –µ—ë –Ω–µ—Ç)
            let albumCover = album.cover || '';
            if (!albumCover || albumCover.trim() === '') {
                // –ò—â–µ–º –æ–±–ª–æ–∂–∫—É –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–∞—Ö
                const checkboxes = document.querySelectorAll(`input.album-track-checkbox[data-album="${albumIndex}"]:checked`);
                for (let cb of checkboxes) {
                    const trackIndex = parseInt(cb.getAttribute('data-track'));
                    if (album.tracks[trackIndex] && album.tracks[trackIndex].cover && album.tracks[trackIndex].cover.trim()) {
                        albumCover = album.tracks[trackIndex].cover.trim();
                        break; // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –æ–±–ª–æ–∂–∫—É
                    }
                }
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
            const checkboxes = document.querySelectorAll(`input.album-track-checkbox[data-album="${albumIndex}"]:checked`);
            checkboxes.forEach(cb => {
                const trackIndex = parseInt(cb.getAttribute('data-track'));
                if (album.tracks[trackIndex]) {
                    const track = album.tracks[trackIndex];
                    selectedTracks.push({
                        title: track.title,
                        duration: track.duration || 0,
                        file_path: 'tracks/music/' + track.title.replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø\s]/g, '').trim().replace(/\s+/g, '_') + '.mp3',
                        cover: track.cover || '', // –í–ê–ñ–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º –æ–±–ª–æ–∂–∫—É —Ç—Ä–µ–∫–∞
                        explicit: track.explicit || 0,
                        trackNumber: track.trackNumber || null,
                        discNumber: track.discNumber || null,
                        genre: track.genre || null,
                        year: track.year || null,
                        previewUrl: track.previewUrl || null,
                        collectionId: track.collectionId || null
                    });
                }
            });
            
            if (selectedTracks.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç—Ä–µ–∫');
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∞–ª—å–±–æ–º–∞
            const albumType = selectedTracks.length <= 3 ? 'single' : (selectedTracks.length <= 7 ? 'ep' : 'album');
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª–∞–º
            const usePlaceholder = confirm(`–ù–∞–π–¥–µ–Ω–æ ${selectedTracks.length} —Ç—Ä–µ–∫–æ–≤.\n\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å placeholder –ø—É—Ç–∏ (tracks/music/track.mp3)?\n\n–ù–∞–∂–º–∏—Ç–µ OK –¥–ª—è placeholder, –û—Ç–º–µ–Ω–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞.`);
            
            if (!usePlaceholder) {
                const pathsInput = prompt(`–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É):\n\n${selectedTracks.map((t, i) => `${i + 1}. ${t.title}`).join('\n')}\n\n–ò–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è placeholder.`);
                if (pathsInput !== null) {
                    const paths = pathsInput.split('\n').map(p => p.trim()).filter(p => p);
                    if (paths.length === selectedTracks.length) {
                        selectedTracks.forEach((track, i) => {
                            track.file_path = paths[i] || track.file_path;
                        });
                    }
                }
            }
            
            const result = document.getElementById('addAlbumResult');
            const content = document.getElementById('addAlbumContent');
            
            content.innerHTML = '<p>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞...</p>';
            result.style.display = 'block';
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—É—é –æ–±–ª–æ–∂–∫—É –∏–ª–∏ –æ–±–ª–æ–∂–∫—É –∞–ª—å–±–æ–º–∞
                const finalCover = albumCover || album.cover || '';
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                console.log('Adding album with cover:', finalCover);
                console.log('Album data:', album);
                console.log('Selected tracks:', selectedTracks);
                
                const response = await fetch('/muzic2/add_album_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        album_name: album.name,
                        artist_name: album.artist,
                        album_type: albumType,
                        selectedCover: finalCover,
                        release_year: album.year || new Date().getFullYear(),
                        description: '',
                        tracks: selectedTracks
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { message: errorText };
                    }
                    throw new Error(errorData.message || `HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    content.innerHTML = `
                        <div class="result-item">
                            <strong>‚úÖ –ê–ª—å–±–æ–º —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!</strong><br>
                            <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${data.data.album_name}<br>
                            <strong>–ê—Ä—Ç–∏—Å—Ç:</strong> ${data.data.artist_name}<br>
                            <strong>–¢–∏–ø:</strong> ${data.data.album_type}<br>
                            <strong>–¢—Ä–µ–∫–æ–≤:</strong> ${data.data.tracks_count}<br>
                            <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${data.data.total_duration}<br>
                            ${data.data.cover ? `<img src="${data.data.cover}" class="cover-preview" alt="cover">` : ''}
                        </div>
                    `;
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('albumArtist').value = '';
                    document.getElementById('albumName').value = '';
                } else {
                    content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–ª—å–±–æ–º–∞:', error);
                content.innerHTML = '<p style="color: #ff4444;">–û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        }
    </script>
</body>
</html>

